<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>confirm_dialog</title>
  <style>
    :root {
      --bg: #f3f5f9;
      --panel: #ffffff;
      --panel-soft: #f7f8fb;
      --line: #dce1ea;
      --line-strong: #c8d0de;
      --text: #202737;
      --sub: #5b667c;
      --muted: #768197;
      --accent: #234fbe;
      --accent-soft: rgba(35, 79, 190, 0.1);
      --danger: #b13b3b;
      --ok: #1b7a5f;
      --shadow: 0 10px 24px rgba(25, 34, 53, 0.06);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      min-height: 100%;
    }

    body {
      font-family: "SF Pro Text", "SF Pro Display", "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 12% 6%, rgba(35, 79, 190, 0.08), transparent 38%),
        linear-gradient(170deg, var(--bg), #f7f8fb 70%);
      padding: 14px;
    }

    .shell {
      width: min(760px, 100%);
      margin: 0 auto;
    }

    .card {
      border: 1px solid var(--line);
      border-radius: 16px;
      background: color-mix(in srgb, var(--panel) 94%, var(--panel-soft));
      box-shadow: var(--shadow);
      padding: 14px;
      display: grid;
      gap: 12px;
    }

    .question {
      margin: 0;
      font-size: 16px;
      line-height: 1.4;
      font-weight: 600;
      letter-spacing: 0.01em;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .options {
      display: grid;
      gap: 8px;
    }

    .option {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: color-mix(in srgb, var(--panel) 90%, var(--panel-soft));
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: border-color 0.16s ease, background-color 0.16s ease;
    }

    .option:hover {
      border-color: var(--line-strong);
      background: color-mix(in srgb, var(--panel) 78%, #ffffff);
    }

    .option.is-selected {
      border-color: color-mix(in srgb, var(--accent) 54%, var(--line));
      background: color-mix(in srgb, var(--accent-soft) 88%, #ffffff);
    }

    .option input[type='radio'] {
      width: 14px;
      height: 14px;
      margin: 0;
      accent-color: var(--accent);
      flex: 0 0 14px;
    }

    .option-label {
      font-size: 13.5px;
      line-height: 1.45;
      color: var(--text);
      word-break: break-word;
      white-space: pre-wrap;
    }

    .free-wrap {
      display: none;
      gap: 8px;
    }

    .free-wrap.show {
      display: grid;
    }

    .free-label {
      font-size: 12.5px;
      color: var(--sub);
    }

    .free-input {
      width: 100%;
      min-height: 72px;
      max-height: 160px;
      resize: vertical;
      border: 1px solid var(--line);
      border-radius: 11px;
      background: #ffffff;
      color: var(--text);
      font-size: 13.5px;
      line-height: 1.45;
      padding: 10px 12px;
      font-family: inherit;
    }

    .free-input:focus {
      outline: none;
      border-color: color-mix(in srgb, var(--accent) 54%, var(--line));
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-soft) 70%, transparent);
    }

    .bar {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 0;
    }

    .status {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }

    .status.ok {
      color: var(--ok);
    }

    .status.err {
      color: var(--danger);
    }

    .submit {
      border: 1px solid color-mix(in srgb, var(--accent) 58%, var(--line));
      border-radius: 10px;
      background: linear-gradient(145deg, #2c5ccf, #234fbe);
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.01em;
      padding: 8px 14px;
      cursor: pointer;
      box-shadow: 0 5px 12px rgba(35, 79, 190, 0.22);
    }

    .submit[disabled] {
      cursor: not-allowed;
      opacity: 0.58;
      box-shadow: none;
    }

    @media (max-width: 560px) {
      body {
        padding: 8px;
      }

      .card {
        border-radius: 12px;
        padding: 11px;
      }

      .question {
        font-size: 14px;
      }

      .submit {
        width: 100%;
      }

      .bar {
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <main class="shell">
    <section class="card" aria-live="polite">
      <h1 id="question" class="question">请确认下一步操作</h1>
      <div id="options" class="options"></div>
      <div id="freeWrap" class="free-wrap">
        <label class="free-label" for="freeInput">请输入自定义内容</label>
        <textarea id="freeInput" class="free-input" placeholder="输入你的自定义选项"></textarea>
        <button id="submit" class="submit" type="button">确定</button>
      </div>
      <div class="bar">
        <span id="status" class="status">请选择一个选项</span>
      </div>
    </section>
  </main>

  <script>
    const CUSTOM_LABEL = '其他（自定义输入）';

    const state = {
      question: '请确认下一步操作',
      options: [],
      allowFreeText: false,
      selectedIndex: -1,
      customIndex: -1
    };

    const elements = {
      question: document.getElementById('question'),
      options: document.getElementById('options'),
      freeWrap: document.getElementById('freeWrap'),
      freeInput: document.getElementById('freeInput'),
      status: document.getElementById('status'),
      submit: document.getElementById('submit')
    };

    function setStatus(text, tone) {
      elements.status.textContent = text;
      elements.status.classList.toggle('ok', tone === 'ok');
      elements.status.classList.toggle('err', tone === 'err');
    }

    function normalizeParams(raw) {
      const params = raw && typeof raw === 'object' ? raw : {};
      const options = Array.isArray(params.options)
        ? params.options
            .map((item) => String(item ?? '').trim())
            .filter(Boolean)
        : [];

      const question = typeof params.question === 'string' && params.question.trim()
        ? params.question.trim()
        : '请确认下一步操作';

      return {
        question,
        options,
        allowFreeText: Boolean(params.allowFreeText)
      };
    }

    function listWithCustom() {
      const list = state.options.slice();
      if (state.allowFreeText) {
        list.push(CUSTOM_LABEL);
      }
      return list;
    }

    function isCustomSelected() {
      return state.allowFreeText && state.customIndex >= 0 && state.selectedIndex === state.customIndex;
    }

    function syncCustomSubmitState() {
      const customSelected = isCustomSelected();
      const hasInput = Boolean(elements.freeInput.value.trim());
      elements.submit.disabled = !customSelected || !hasInput;
    }

    function syncFreeInput() {
      const customSelected = isCustomSelected();
      elements.freeWrap.classList.toggle('show', customSelected);
      if (!customSelected) {
        elements.freeInput.value = '';
        syncCustomSubmitState();
        return;
      }
      syncCustomSubmitState();
      window.setTimeout(() => {
        elements.freeInput.focus();
      }, 0);
    }

    function renderOptions() {
      elements.options.innerHTML = '';
      state.customIndex = state.allowFreeText ? state.options.length : -1;

      const list = listWithCustom();
      for (let index = 0; index < list.length; index += 1) {
        const labelText = list[index];
        const row = document.createElement('label');
        row.className = 'option';

        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'confirm-option';
        radio.value = String(index);
        radio.checked = state.selectedIndex === index;
        radio.addEventListener('change', () => {
          state.selectedIndex = index;
          markSelectedOption();
          syncFreeInput();
          if (isCustomSelected()) {
            setStatus('请输入内容后点击确定，或按回车提交', 'normal');
            return;
          }
          submit();
        });

        const label = document.createElement('span');
        label.className = 'option-label';
        label.textContent = labelText;

        row.append(radio, label);
        elements.options.appendChild(row);
      }

      markSelectedOption();
      syncFreeInput();
    }

    function markSelectedOption() {
      const rows = elements.options.querySelectorAll('.option');
      rows.forEach((row, idx) => {
        row.classList.toggle('is-selected', idx === state.selectedIndex);
      });
    }

    function applyInitPayload(raw) {
      const payload = raw && typeof raw === 'object' ? raw : {};
      const params = payload.params && typeof payload.params === 'object'
        ? payload.params
        : payload;
      const normalized = normalizeParams(params);

      state.question = normalized.question;
      state.options = normalized.options;
      state.allowFreeText = normalized.allowFreeText;
      state.customIndex = state.allowFreeText ? state.options.length : -1;
      state.selectedIndex = -1;

      elements.question.textContent = state.question;
      renderOptions();

      if (listWithCustom().length === 0) {
        setStatus('暂无可选项', 'err');
      } else {
        setStatus('请选择一个选项', 'normal');
      }
    }

    function buildSubmitParams() {
      const list = listWithCustom();
      if (list.length === 0 || state.selectedIndex < 0 || state.selectedIndex >= list.length) {
        throw new Error('请先选择一个选项');
      }

      const custom = isCustomSelected();
      const freeText = custom ? elements.freeInput.value.trim() : '';
      if (custom && !freeText) {
        throw new Error('已选择自定义，请填写内容');
      }

      return {
        selectedOption: custom ? freeText : list[state.selectedIndex],
        selectedIndex: state.selectedIndex + 1,
        freeText,
        isCustom: custom
      };
    }

    function submit() {
      try {
        const params = buildSubmitParams();
        window.parent.postMessage(
          {
            type: 'frontend_submit',
            params
          },
          '*'
        );
        setStatus('已提交，等待处理...', 'ok');
      } catch (error) {
        setStatus(error && error.message ? error.message : '提交失败', 'err');
      }
    }

    elements.submit.addEventListener('click', submit);

    elements.freeInput.addEventListener('input', () => {
      syncCustomSubmitState();
    });

    elements.freeInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        submit();
      }
    });

    window.addEventListener('message', (event) => {
      const message = event.data;
      if (!message || typeof message !== 'object') {
        return;
      }
      if (message.type !== 'tool_init') {
        return;
      }
      applyInitPayload(message.data || {});
    });

    applyInitPayload({
      params: {
        question: '请确认下一步操作',
        options: ['继续执行', '改用更保守方案', '停止并返回'],
        allowFreeText: true
      }
    });
  </script>
</body>
</html>
